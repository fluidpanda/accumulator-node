<html lang="en">
    <head>
        <title>Accumulator</title>
        <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
        <link rel="stylesheet" type="text/css" href="style.css" />
    </head>
    <body>
        <h1>Accumulator</h1>
        <div id="cards" class="cards"> </div>
        <script type="text/javascript">
            // <![CDATA[
            function el(tag, className, text) {
                const x = document.createElement(tag);
                if (className) x.className = className;
                if (text !== undefined) x.textContent = text;
                return x;
            }
            function getCo2ppm(snapshot) {
                if (!snapshot || !snapshot.metrics) return null;
                const v = snapshot.metrics["co2ppm"];
                return typeof v === "number" && isFinite(v) ? v : null;
            }
            function renderPlaceholder(container) {
                const card = el("div", "card placeholder");
                card.appendChild(el("div", "label", "No devices"));
                card.appendChild(el("div", "muted", "Waiting for UDP announce..."));
                container.appendChild(card);
            }
            function createDeviceCard(d) {
                const card = el("div", "card");
                card.setAttribute("data-device-id", d.id);
                card.appendChild(el("div", "label", "Device"));
                card.appendChild(el("div", "mono", d.id));
                card.appendChild(el("div", "label", "CO₂"));
                const value = el("div", "value", "—");
                value.setAttribute("data-role", "co2ppm");
                card.appendChild(value);
                const status = el("div", "muted", "Waiting for first snapshot...");
                status.setAttribute("data-role", "status");
                card.appendChild(status);
                return card;
            }
            function updateDeviceCard(card, d) {
                const co2ppm = getCo2ppm(d.snapshot);
                const value = card.querySelector('[data-role="co2ppm"]');
                const status = card.querySelector('[data-role="status"]');
                value.textContent = co2ppm === null ? "—" : String(co2ppm);
                if (co2ppm !== null && co2ppm > 600) {
                    value.classList.add("warning");
                } else {
                    value.classList.remove("warning");
                }
                if (!d.snapshot) {
                    status.textContent = "Waiting for first snapshot...";
                } else {
                    status.textContent = d.snapshot.ok ? "OK" : "ERROR: " + (d.snapshot.lastError || "unknown");
                }
            }
            function renderState(state) {
                const container = document.getElementById("cards");
                if (!state || !state.devices || state.devices.length === 0) {
                    container.innerHTML = "";
                    renderPlaceholder(container);
                    return;
                }
                const existing = {};
                const nodes = container.querySelectorAll(".card[data-device-id]");
                for (let i = 0; i < nodes.length; i++) {
                    existing[nodes[i].getAttribute("data-device-id")] = nodes[i];
                }
                const placeholders = container.querySelectorAll(".card.placeholder");
                for (let j = 0; j < placeholders.length; j++) {
                    container.removeChild(placeholders[j]);
                }
                for (let k = 0; k < state.devices.length; k++) {
                    const d = state.devices[k];
                    let card = existing[d.id];
                    if (!card) {
                        card = createDeviceCard(d);
                        container.appendChild(card);
                    }
                    updateDeviceCard(card, d);
                }
            }
            async function tick() {
                try {
                    const res = await fetch("/api/state");
                    const state = await res.json();
                    renderState(state);
                } catch (err) {}
            }
            setInterval(tick, 5000);
            tick();
            // ]]>
        </script>
    </body>
</html>
