<html lang="en">
    <head>
        <title>Accumulator</title>
        <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
        <link rel="stylesheet" type="text/css" href="style.css" />
    </head>
    <body>
        <h1>Accumulator</h1>
        <div id="cards" class="cards"> </div>
        <script type="text/javascript">
            // <![CDATA[
            function el(tag, className, text) {
                const x = document.createElement(tag);
                if (className) x.className = className;
                if (text !== undefined) x.textContent = text;
                return x;
            }

            function byId(id) {
                const x = document.getElementById(id);
                if (!x) throw new Error(`Missing element id="${id}"`);
                return x;
            }

            function qs(root, selector) {
                const x = root.querySelector(selector);
                if (!x) throw new Error(`Missing element: ${selector}`);
                return x;
            }

            function getCo2ppm(snapshot) {
                if (!snapshot || !snapshot.metrics) return null;
                const v = snapshot.metrics["co2ppm"];
                return typeof v === "number" && Number.isFinite(v) ? v : null;
            }

            function renderPlaceholder(container) {
                container.innerHTML = "";
                const card = el("div", "card placeholder");
                card.appendChild(el("div", "label", "No devices"));
                card.appendChild(el("div", "muted", "Waiting for UDP announce..."));
                container.appendChild(card);
            }

            function createDeviceCard(d) {
                const card = el("div", "card");
                card.setAttribute("data-device-id", d.id);
                card.appendChild(el("div", "label", "Device"));
                card.appendChild(el("div", "mono", d.id));
                card.appendChild(el("div", "label", "CO₂"));
                const value = el("div", "value", "—");
                value.setAttribute("data-role", "co2ppm");
                card.appendChild(value);
                const status = el("div", "muted", "Waiting for first snapshot...");
                status.setAttribute("data-role", "status");
                card.appendChild(status);
                return card;
            }

            function updateDeviceCard(card, d) {
                const co2ppm = getCo2ppm(d.snapshot);
                const value = qs(card, '[data-role="co2ppm"]');
                const status = qs(card, '[data-role="status"]');
                value.textContent = co2ppm === null ? "—" : String(co2ppm);
                if (co2ppm !== null && co2ppm > 600) value.classList.add("warning");
                else value.classList.remove("warning");
                if (!d.snapshot) {
                    status.textContent = "Waiting for first snapshot...";
                } else {
                    status.textContent = d.snapshot.ok ? "OK" : `ERROR: ${d.snapshot.lastError || "unknown"}`;
                }
            }

            function renderState(state) {
                const container = byId("cards");
                if (!state || !state.devices || state.devices.length === 0) {
                    renderPlaceholder(container);
                    return;
                }
                const existing = new Map();
                const nodes = container.querySelectorAll(".card[data-device-id]");
                for (const node of nodes) {
                    const id = node.getAttribute("data-device-id");
                    if (id) existing.set(id, node);
                }
                for (const ph of container.querySelectorAll(".card.placeholder")) {
                    ph.remove();
                }
                for (const d of state.devices) {
                    let card = existing.get(d.id);
                    if (!card) {
                        card = createDeviceCard(d);
                        container.appendChild(card);
                    }
                    updateDeviceCard(card, d);
                }
                for (const [id, card] of existing) {
                    if (!state.devices.some((d) => d.id === id)) card.remove();
                }
            }

            async function tick() {
                const res = await fetch("/api/state");
                const state = (await res.json());
                renderState(state);
            }

            function start() {
                void tick().catch((err) => console.error(err));
                setInterval(() => {
                    void tick().catch((err) => console.error(err));
                }, 5000);
            }

            start();
            // ]]>
        </script>
    </body>
</html>
